# golangci-lint configuration for s9s
version: "2"

run:
  timeout: 10m
  tests: true
  skip-dirs:
    - vendor
    - .git
    - .github

linters:
  disable-all: true
  enable:
    # Core linters - focusing on critical issues only
    - errcheck      # Unchecked errors are critical
    - govet         # Suspicious constructs
    - ineffassign   # Ineffective assignments
    # staticcheck: 82/82 Phase 1 issues fixed (PR #13 + PR #16) âœ…
    - staticcheck   # Enabled: all Phase 1 issues resolved
    # gosec: Phase 2 complete - 15/40 file permission issues fixed (PR #17)
    # Remaining 24 issues suppressed with nolint comments and security documentation

    # Additional linters - Phase 7
    # Note: gofumpt and goimports are handled by pre-commit hooks and Makefile
    - misspell      # Check for commonly misspelled English words
    - bodyclose     # Check HTTP response body is closed
    - errorlint     # Find code that will cause problems with Go 1.13 error wrapping (fixed in this PR)
    - wastedassign  # Finds wasted assignment statements (fixed in this PR)
    # gosec: Phase 2 complete - 15/40 file permission issues fixed, 24 remaining analyzed
    - gosec         # Enabled: exclusion rules configured in linters-settings
    # gocritic: Phase 3d - style and code pattern checks
    - gocritic      # Enabled: disabled checks configured in linters-settings
    # unused: Phase 3e - unused variables and code
    - unused        # Enabled: final phase to remove dead code

    # Phase 4: Advanced linters
    # - cyclop        # Cyclomatic complexity checking - 136 issues, disabled pending configuration fix
    - gocognit      # Cognitive complexity checking
    - nolintlint    # Validate nolint directives
    - dupl          # Detect duplicated code
    # - wsl_v5      # Whitespace linting - too many pre-existing issues (2600+), disabled for now
    # - containedctx # Prevent context.Context in struct fields - 22 pre-existing instances, requires architectural refactor
    # - revive      # Too many issues (460+), disabled to focus on complexity/duplication

  disable:
    # Temporarily disabled - will be fixed in follow-up PRs
    - noctx         # 7 issues - all in test/integration files where context is not required
    # TODO(Phase3c): Re-enable noctx after fixing test file exclusion rule patterns

linters-settings:
  errcheck:
    check-type-assertions: true
    check-blank: false  # Allow _ = assignment for intentionally ignored errors

  govet:
    enable:
      - shadow

  gosec:
    # Security severity threshold
    severity: medium
    confidence: medium
    # Exclude specific rules that are false positives or acceptable in our context
    excludes:
      # G204 is often a false positive when using exec.Command with separate args
      # We've reviewed all exec.Command usage and they use proper argument separation
      - G204
      # G304: File inclusion via variable acceptable for app-controlled directories
      # All instances in observability plugin use internal config/storage/persistence paths
      # Not user-supplied input - constructed from application configuration only
      - G304
      # G115: Integer overflow conversions safe in all cases
      # Metrics code: NumGoroutine() fits in int32, memory metrics are bounded
      # Test code: Type conversions for logging/assertions are safe
      - G115
      # G602: Slice index out of range false positives
      # Only occurs in test code using modulo operations (i%3, i%4) with safe bounds
      - G602
      # G101: Hardcoded credentials acceptable in test context
      # Test RSA key in key_manager_test.go is non-production and properly commented
      - G101

  gocritic:
    # Enable multiple checks by tags
    enabled-tags:
      - diagnostic
      - performance
      - style
    disabled-checks:
      - dupImport # https://github.com/go-critic/go-critic/issues/845
      - ifElseChain  # Style preference, too many pre-existing instances
      - singleCaseSwitch  # Style preference, too many pre-existing instances
      - dupBranchBody  # Acceptable in some cases
      - octalLiteral
      - whyNoLint

  errorlint:
    # Check whether fmt.Errorf uses the %w verb for formatting errors
    errorf: true
    # Check for plain type assertions and type switches
    asserts: true
    # Check for plain error comparisons
    comparison: true

  misspell:
    # Correct spellings using locale preferences for US or UK
    locale: US

  # Phase 4: Advanced Linters
  # cyclop:
  #   # Cyclomatic complexity threshold - disabled pending configuration fix
  #   # 136 pre-existing issues exceed reasonable thresholds
  #   # max-complexity: 25
  #   # skip-tests: true

  gocognit:
    # Cognitive complexity threshold (different from cyclomatic)
    # Measures how difficult code is to understand
    min-complexity: 30
    skip-tests: true

  nolintlint:
    # Check validity of nolint directives
    allow-unused: false     # Disallow unused nolint directives
    allow-leading-space: false  # Require //nolint without space
    require-explanation: false  # Don't require explanation (too verbose)
    require-specific: false  # Allow //nolint without specific rule name

  dupl:
    # Detect duplicated code blocks
    threshold: 150  # Minimum lines to consider as duplication

  containedctx:
    # Prevent storing context.Context in struct fields
    # Context should be passed as function parameter
    skip-tests: true  # Allow in test helpers

issues:
  exclude-files:
    - ".*\\.pb\\.go$"
    - ".*\\.gen\\.go$"

  exclude-dirs:
    - vendor
    - third_party
    - testdata

  exclude-rules:
    # Exclude shadow warnings for common err pattern
    - text: "shadow: declaration of \"err\""
      linters:
        - govet

    # unparam: Unused parameters in tests are acceptable
    - text: "- .* is unused"
      linters:
        - unparam
      path: "_test\\.go"

    # unparam: Functions that always return nil are acceptable if designed for future errors
    # These functions are intentionally designed to return errors for extensibility
    - text: "result .* \\(error\\) is always nil"
      linters:
        - unparam
      path: "internal/app/app.*\\.go"

    # Exclude certain linters from test files - tests have different patterns
    - linters:
        - unparam
        - prealloc
        - gocritic
        - containedctx
      path: ".*_test\\.go"

    # Pre-existing gosec issues in auth and config packages
    - text: "G404: Use of weak random"
      linters:
        - gosec
      path: "internal/auth/"

    - text: "(G301|G304|G306):"
      linters:
        - gosec
      path: "(internal/auth|internal/config|internal/cli)/"

    # Phase 4: containedctx - Pre-existing patterns in main app structures
    - text: "found a struct"
      linters:
        - containedctx

    # Phase 3: unconvert, prealloc, and unparam issues to be addressed
    # Temporarily disabling blanket exclusions to assess scope
    # - linters:
    #     - unconvert
    # - linters:
    #     - unparam
    #   path: "internal/(views|ui|layouts|discovery|monitoring|ssh)/"
    # - linters:
    #     - prealloc

    # Phase 4: dupl - code duplication
    # Test files have intentional duplication (test data, similar test patterns)
    - linters:
        - dupl
      path: ".*_test\\.go|test/"

    # Phase 4: nolintlint - unused nolint directives
    # Some directives reference rules excluded globally in gosec configuration
    - text: "directive.*is unused"
      linters:
        - nolintlint
        - gosec

  max-issues-per-linter: 0
  max-same-issues: 0
